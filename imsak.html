<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Overlay Imsakiyah Final - Size Locked</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

        body { margin: 0; padding: 0; background-color: transparent; font-family: 'Roboto', sans-serif; overflow: hidden; }

        /* --- CONTAINER UTAMA --- */
        .container {
            position: absolute;
            bottom: 20px; left: 20px;
            display: flex; align-items: center;
            background: linear-gradient(90deg, #141E30, #243B55); 
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border-bottom: 4px solid #00d2ff;
            /* width: fit-content; <--- DIHAPUS AGAR TIDAK GOYANG */
            transition: background 0.3s ease, color 0.3s ease;
            height: 90px;
        }

        /* --- ALERT STYLES --- */
        .container.alert-imsak { background: linear-gradient(90deg, #FFC312, #F79F1F); border-bottom: 4px solid #12CBC4; color: #2f3640; animation: pulse-yellow 1s infinite alternate; }
        .container.alert-subuh { background: linear-gradient(90deg, #EA2027, #833471); border-bottom: 4px solid #FFC312; color: white; animation: pulse-red 1s infinite alternate; }
        .container.alert-maghrib { background: linear-gradient(90deg, #009432, #A3CB38); border-bottom: 4px solid #ffffff; color: white; animation: pulse-green 1s infinite alternate; }

        /* --- SECTIONS KIRI (Jam & Kota) --- */
        .clock-section { 
            background-color: rgba(0, 0, 0, 0.2); 
            height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            padding: 0 20px; 
            border-top-left-radius: 8px; border-bottom-left-radius: 8px; 
            min-width: 90px; 
            border-right: 1px solid rgba(255,255,255,0.1); 
        }
        .clock-time { font-size: 26px; font-weight: 700; line-height: 1; }
        .clock-label { font-size: 10px; opacity: 0.8; margin-top: 5px; }

        .city-section { 
            padding: 0 25px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            min-width: 180px; 
            height: 100%; 
        }
        .city-name { font-size: 26px; font-weight: 900; text-transform: uppercase; color: #00d2ff; line-height: 1; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .date-text { font-size: 12px; opacity: 0.8; font-weight: 400; text-transform: uppercase; letter-spacing: 1px; }

        /* Text Color Adjustments on Alert */
        .container.alert-imsak .city-name { color: #2f3640; text-shadow: none; }
        .container.alert-subuh .city-name { color: #FFC312; }
        .container.alert-maghrib .city-name { color: #fff; }

        /* --- WRAPPER KANAN (Fix Size Logic) --- */
        .right-wrapper {
            position: relative; /* Agar anak-anaknya bisa absolute */
            height: 100%;
            display: flex;
            align-items: center;
            padding-right: 25px;
            /* Kita tidak set width fix pixel disini agar tetap fleksibel, 
               tapi strukturnya menjamin alert menimpa jadwal tanpa ubah ukuran container */
        }

        /* 1. BAGIAN JADWAL */
        .schedule-section { 
            display: flex; 
            gap: 20px; 
            align-items: center; 
            transition: opacity 0.3s ease; /* Transisi halus saat hilang */
        }
        .time-box { text-align: center; }
        .time-label { font-size: 10px; opacity: 0.7; margin-bottom: 2px; font-weight: 700; letter-spacing: 1px; }
        .time-value { font-size: 22px; font-weight: 700; }

        /* 2. BAGIAN ALERT MESSAGE (Overlay Ghost) */
        .alert-message { 
            position: absolute; /* Menimpa tepat di atas jadwal */
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            text-align: center;
            font-size: 18px; /* Ukuran pas */
            font-weight: 900; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            opacity: 0; /* Sembunyi secara default */
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* --- LOGIC VISIBILITY (Mainin Opacity) --- */
        /* Saat Alert Aktif: Jadwal jadi transparan (tapi tempatnya masih ada) */
        .container.alert-imsak .schedule-section, 
        .container.alert-subuh .schedule-section, 
        .container.alert-maghrib .schedule-section { 
            opacity: 0; 
        }

        /* Saat Alert Aktif: Pesan muncul */
        .container.alert-imsak .alert-message, 
        .container.alert-subuh .alert-message, 
        .container.alert-maghrib .alert-message { 
            opacity: 1; 
        }

        /* Animasi Pulse */
        @keyframes pulse-yellow { from { box-shadow: 0 0 10px rgba(255, 195, 18, 0.4); } to { box-shadow: 0 0 25px rgba(255, 195, 18, 0.9); } }
        @keyframes pulse-red { from { box-shadow: 0 0 10px rgba(234, 32, 39, 0.4); } to { box-shadow: 0 0 25px rgba(234, 32, 39, 0.9); } }
        @keyframes pulse-green { from { box-shadow: 0 0 10px rgba(0, 148, 50, 0.4); } to { box-shadow: 0 0 25px rgba(0, 148, 50, 0.9); } }
    </style>
</head>
<body>

    <div class="container" id="mainContainer">
        <div class="clock-section">
            <div class="clock-time" id="pcClock">--:--</div>
            <div class="clock-label">WIB</div>
        </div>
        
        <div class="city-section">
            <div class="city-name" id="cityName">LOADING...</div>
            <div class="date-text" id="dateDisplay">-- -- --</div>
        </div>

        <div class="right-wrapper">
            
            <div class="schedule-section">
                <div class="time-box">
                    <div class="time-label">IMSAK</div>
                    <div class="time-value" id="imsakTime">--:--</div>
                </div>
                <div class="time-box">
                    <div class="time-label">SUBUH</div>
                    <div class="time-value" id="subuhTime">--:--</div>
                </div>
                <div class="time-box">
                    <div class="time-label">MAGHRIB</div>
                    <div class="time-value" id="maghribTime">--:--</div>
                </div>
            </div>

            <div class="alert-message" id="alertText">
                SUDAH MASUK WAKTU
            </div>

        </div>
    </div>

    <script>
        // ==========================================
        // 1. KONFIGURASI TANGGAL MULAI
        // ==========================================
        const START_DATE = "2026-02-19"; 

        // ==========================================
        // 2. DATA KOTA
        // ==========================================
        let schedules = [
            { 
                city: "Padang", 
                imsak: "05:02", subuh: "05:12", maghrib: "18:40", 
                useApi: true,
                apiParams: { provinsi: "Sumatera Barat", kabkota: "Kota Padang" }
            },
            { 
                city: "Jakarta", 
                imsak: "04:31", subuh: "04:41", maghrib: "18:18", 
                useApi: true,
                apiParams: { provinsi: "DKI Jakarta", kabkota: "Kota Jakarta" }
            },
            { 
                city: "Surabaya", 
                imsak: "04:07", subuh: "04:17", maghrib: "17:55", 
                useApi: true,
                apiParams: { provinsi: "Jawa Timur", kabkota: "Kota Surabaya" }
            },
            { 
                city: "Kediri", 
                imsak: "04:09", subuh: "04:19", maghrib: "17:59", 
                useApi: true,
                apiParams: { provinsi: "Jawa Timur", kabkota: "Kota Kediri" }
            },
            { 
                city: "Bandung", 
                imsak: "04:28", subuh: "04:38", maghrib: "18:20", 
                useApi: true,
                apiParams: { provinsi: "Jawa Barat", kabkota: "Kota Bandung" }
            },
            { 
                city: "Pekanbaru", 
                imsak: "04:59", subuh: "05:09", maghrib: "18:34", 
                useApi: true,
                apiParams: { provinsi: "Riau", kabkota: "Kota Pekanbaru" }
            },
            { 
                city: "Denpasar", 
                imsak: "04:55", subuh: "05:05", maghrib: "18:46", 
                useApi: true,
                apiParams: { provinsi: "Bali", kabkota: "Kota Denpasar" }
            }
        ];

        // Global Variables
        let currentIndex = 0;
        let isAlertActive = false;
        
        // References
        const container = document.getElementById('mainContainer');
        const elCity = document.getElementById('cityName');
        const elDate = document.getElementById('dateDisplay');
        const elImsak = document.getElementById('imsakTime');
        const elSubuh = document.getElementById('subuhTime');
        const elMaghrib = document.getElementById('maghribTime');
        const elClock = document.getElementById('pcClock');
        const elAlertText = document.getElementById('alertText');

        // ==========================================
        // 3. FUNGSI FETCH API
        // ==========================================
        async function fetchApiData() {
            // Hitung hari ke berapa sekarang (Index 0 = Tanggal 1)
            const start = new Date(START_DATE + 'T00:00:00'); // Force midnight
            const now = new Date();
            now.setHours(0,0,0,0); // Force midnight hari ini agar hitungan hari pas
            
            // Hitung selisih hari
            const diffTime = now - start;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Validasi: Apakah hari ini masih dalam rentang 30 hari puasa?
            if (diffDays < 0 || diffDays > 29) {
                console.log("Tanggal PC diluar rentang jadwal API (1-30). Menggunakan default.");
                // Tetap update display agar tidak blank
                updateDisplay();
                return; 
            }

            console.log(`Mengambil data API untuk hari ke-${diffDays + 1} (Index array: ${diffDays})`);

            // Loop semua kota, cari yang butuh API
            for (let i = 0; i < schedules.length; i++) {
                if (schedules[i].useApi) {
                    try {
                        const response = await fetch("https://equran.id/api/v2/imsakiyah", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(schedules[i].apiParams)
                        });

                        const result = await response.json();
                        
                        if (result.code === 200 && result.data && result.data.imsakiyah) {
                            // Ambil data array sesuai index hari ini
                            const todaysData = result.data.imsakiyah[diffDays];
                            
                            if (todaysData) {
                                // Update data di memory
                                schedules[i].imsak = todaysData.imsak;
                                schedules[i].subuh = todaysData.subuh;
                                schedules[i].maghrib = todaysData.maghrib;
                                console.log(`Data ${schedules[i].city} berhasil diupdate dari API.`);
                            }
                        }
                    } catch (error) {
                        console.error(`Gagal ambil API untuk ${schedules[i].city}:`, error);
                    }
                }
            }
            // Update tampilan setelah fetch selesai
            updateDisplay();
        }

        // ==========================================
        // 4. CORE LOGIC (Alert & Rotate)
        // ==========================================

        function updateClock() {
            const now = new Date();
            elClock.innerText = now.toLocaleTimeString('id-ID', { hour12: false });
            
            // Update tanggal text
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            elDate.innerText = now.toLocaleDateString('id-ID', dateOptions);

            // Cek Alarm (Hilangkan detik)
            const currentHM = now.toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit' }).replace('.', ':');
            checkAlarm(currentHM);
        }

        function checkAlarm(currentTime) {
            const matchImsak = schedules.find(s => s.imsak === currentTime);
            const matchSubuh = schedules.find(s => s.subuh === currentTime);
            const matchMaghrib = schedules.find(s => s.maghrib === currentTime);

            if (matchImsak) activateAlert(matchImsak, 'IMSAK');
            else if (matchSubuh) activateAlert(matchSubuh, 'SUBUH');
            else if (matchMaghrib) activateAlert(matchMaghrib, 'MAGHRIB');
            else {
                if (isAlertActive && !matchImsak && !matchSubuh && !matchMaghrib) {
                    deactivateAlert();
                }
            }
        }

        function activateAlert(cityData, type) {
            if (isAlertActive && elCity.innerText === cityData.city.toUpperCase() && container.dataset.type === type) return;
            isAlertActive = true;
            container.dataset.type = type;
            elCity.innerText = cityData.city.toUpperCase();
            container.classList.remove('alert-imsak', 'alert-subuh', 'alert-maghrib');

            if (type === 'IMSAK') {
                container.classList.add('alert-imsak');
                elAlertText.innerText = "SUDAH MASUK WAKTU IMSAK";
            } else if (type === 'SUBUH') {
                container.classList.add('alert-subuh');
                elAlertText.innerText = "SUDAH MASUK WAKTU SUBUH";
            } else if (type === 'MAGHRIB') {
                container.classList.add('alert-maghrib');
                elAlertText.innerText = "SUDAH MASUK WAKTU BERBUKA";
            }
        }

        function deactivateAlert() {
            isAlertActive = false;
            container.dataset.type = '';
            container.classList.remove('alert-imsak', 'alert-subuh', 'alert-maghrib');
            updateDisplay(); 
        }

        function rotateCity() {
            if (isAlertActive) return;
            currentIndex = (currentIndex + 1) % schedules.length;
            updateDisplay();
        }

        function updateDisplay() {
            if (isAlertActive) return;
            const data = schedules[currentIndex];
            elCity.innerText = data.city.toUpperCase();
            elImsak.innerText = data.imsak;
            elSubuh.innerText = data.subuh;
            elMaghrib.innerText = data.maghrib;
        }

        // ==========================================
        // 5. INITIALIZATION
        // ==========================================
        
        // Panggil Fetch API saat script dimulai
        fetchApiData().then(() => {
            updateDisplay();
        });

        // Set interval cek API 1 jam sekali
        setInterval(fetchApiData, 3600000); 

        // Interval standar
        setInterval(updateClock, 1000);
        setInterval(rotateCity, 7000); 

    </script>
</body>

</html>
